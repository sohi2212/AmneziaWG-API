# Документация по API AmneziaWG-EASY

Этот документ предоставляет подробную информацию о RESTful API AmneziaWG-EASY.

## Базовый URL

Все конечные точки (endpoints) API начинаются с префикса `/api`.

## Аутентификация

Большинство конечных точек API требуют аутентификации. Аутентификация основана на сессиях. Сессия создается путем отправки пароля на эндпоинт `POST /api/session`. Если на сервере не установлена переменная окружения `PASSWORD`, пароль не требуется, и все эндпоинты доступны без аутентификации.

После успешной аутентификации сессия поддерживается с помощью cookie.

---

## 1. Управление сессией

### 1.1. Получить статус сессии
- **Эндпоинт:** `GET /api/session`
- **Описание:** Проверяет текущий статус аутентификации.
- **Аутентификация:** Не требуется.
- **Ответ (200 OK):**
  ```json
  {
    "requiresPassword": true,
    "authenticated": false
  }
  ```
  - `requiresPassword` (boolean): `true`, если сервер настроен с паролем.
  - `authenticated` (boolean): `true`, если текущая сессия аутентифицирована.

### 1.2. Вход в систему
- **Эндпоинт:** `POST /api/session`
- **Описание:** Аутентифицирует пользователя и создает новую сессию.
- **Аутентификация:** Не требуется.
- **Тело запроса:**
  ```json
  {
    "password": "your_password",
    "remember": true
  }
  ```
  - `password` (string, обязательный): Пароль для веб-интерфейса.
  - `remember` (boolean, необязательный): Если `true`, cookie сессии будет иметь более длительный срок действия (если это настроено на сервере).
- **Ответ (200 OK):**
  ```json
  {
    "success": true
  }
  ```
- **Ответ об ошибке (401 Unauthorized):**
  ```json
  {
    "error": "Incorrect Password"
  }
  ```

### 1.3. Выход из системы
- **Эндпоинт:** `DELETE /api/session`
- **Описание:** Завершает текущую сессию.
- **Аутентификация:** Требуется.
- **Ответ (200 OK):**
  ```json
  {
    "success": true
  }
  ```

---

## 2. Общие настройки и параметры интерфейса

Эта группа эндпоинтов предоставляет различную информацию о конфигурации сервера и пользовательского интерфейса. Все они требуют аутентификации.

- `GET /api/release`: Возвращает текущую версию релиза приложения.
- `GET /api/lang`: Возвращает настроенный код языка (например, `"en"`).
- `GET /api/remember-me`: Возвращает `true`, если включена функция "Запомнить меня".
- `GET /api/ui-traffic-stats`: Возвращает `true`, если в интерфейсе включена статистика трафика.
- `GET /api/ui-chart-type`: Возвращает тип диаграммы, используемой в интерфейсе (например, `"line"`).
- `GET /api/wg-enable-one-time-links`: Возвращает `true`, если включены одноразовые ссылки для ска��ивания конфигураций клиентов.
- `GET /api/ui-sort-clients`: Возвращает `true`, если включена сортировка клиентов.
- `GET /api/wg-enable-expire-time`: Возвращает `true`, если включено время истечения срока действия для клиентов.
- `GET /api/ui-avatar-settings`: Возвращает настройки для аватаров клиентов.
  - **Пример ответа:**
    ```json
    {
      "dicebear": "identicon",
      "gravatar": "true"
    }
    ```

---

## 3. Управление клиентами WireGuard

### 3.1. Список клиентов
- **Эндпоинт:** `GET /api/wireguard/client`
- **Описание:** Получает список всех клиентов WireGuard.
- **Аутентификация:** Требуется.
- **Ответ (200 OK):** Массив объектов клиентов.
  ```json
  [
    {
      "id": "client_id_string",
      "name": "My Phone",
      "publicKey": "...",
      "presharedKey": "...",
      "address": "10.0.0.2/32",
      "createdAt": "2023-10-27T10:00:00.000Z",
      "updatedAt": "2023-10-27T10:00:00.000Z",
      "latestHandshakeAt": "2023-10-27T11:00:00.000Z",
      "transferRx": 1024,
      "transferTx": 2048,
      "endpoint": "...",
      "enabled": true,
      "expiredAt": null,
      "oneTimeLink": "onetime_link_string"
    }
  ]
  ```

### 3.2. Создать нового клиента
- **Эндпоинт:** `POST /api/wireguard/client`
- **Описание:** Создает нового клиента WireGuard.
- **Аутентификация:** Требуется.
- **Тело запроса:**
  ```json
  {
    "name": "New Client Name",
    "expiredDate": "2024-12-31T23:59:59.000Z"
  }
  ```
  - `name` (string, обязательный): Имя для нового клиента.
  - `expiredDate` (string, необязательный): Дата истечения срока действия клиента в формате ISO 8601.
- **Ответ (200 OK):**
  ```json
  {
    "success": true
  }
  ```

### 3.3. Удалить клиента
- **Эндпоинт:** `DELETE /api/wireguard/client/{clientId}`
- **Описание:** Удаляет указанного клиента WireGuard.
- **Аутентификация:** Требуется.
- **Параметры URL:**
  - `clientId` (string, обязательный): ID клиента, которого нужно удалить.
- **Ответ (200 OK):**
  ```json
  {
    "success": true
  }
  ```

### 3.4. Обновить имя клиента
- **Эндпоинт:** `PUT /api/wireguard/client/{clientId}/name`
- **Описание:** Обновляет имя указанного клиента.
- **Аутентификация:** Требуется.
- **Параметры URL:**
  - `clientId` (string, обязательный): ID клиента.
- **Тело запроса:**
  ```json
  {
    "name": "Updated Client Name"
  }
  ```
- **Ответ (200 OK):**
  ```json
  {
    "success": true
  }
  ```

### 3.5. Обновить адрес клиента
- **Эндпоинт:** `PUT /api/wireguard/client/{clientId}/address`
- **Описание:** Обновляет внутренний IP-адрес указанного клиента.
- **Аутентификация:** Требуется.
- **Параметры URL:**
  - `clientId` (string, обязательный): ID клиента.
- **Тело запроса:**
  ```json
  {
    "address": "10.0.0.10/32"
  }
  ```
- **Ответ (200 OK):**
  ```json
  {
    "success": true
  }
  ```

### 3.6. Обновить дату истечения срока действия клиента
- **Эндпоинт:** `PUT /api/wireguard/client/{clientId}/expireDate`
- **Описание:** Обновляет или устанавливает дату истечения срока действия для клиента.
- **Аутентификация:** Требуется.
- **Параметры URL:**
  - `clientId` (string, обязательный): ID клиента.
- **Тело запроса:**
  ```json
  {
    "expireDate": "2025-01-01T00:00:00.000Z"
  }
  ```
- **Ответ (200 OK):**
  ```json
  {
    "success": true
  }
  ```

### 3.7. Включить клиента
- **Эндпоинт:** `POST /api/wireguard/client/{clientId}/enable`
- **Описание:** Включает отключенного клиента.
- **Аутентификация:** Требуется.
- **Параметры URL:**
  - `clientId` (string, обязательный): ID клиента.
- **Ответ (200 OK):**
  ```json
  {
    "success": true
  }
  ```

### 3.8. Отключить клиента
- **Эндпоинт:** `POST /api/wireguard/client/{clientId}/disable`
- **Описание:** Отключает клиента, запрещая ему подключаться.
- **Аутентификация:** Требуется.
- **Параметры URL:**
  - `clientId` (string, обязательный): ID клиента.
- **Ответ (200 OK):**
  ```json
  {
    "success": true
  }
  ```

---

## 4. Конфигурация и файлы клиентов

### 4.1. Получить QR-код клиента
- **Эндпоинт:** `GET /api/wireguard/client/{clientId}/qrcode.svg`
- **Описание:** Генерирует и возвращает конфигурацию клиента в виде QR-кода в формате SVG.
- **Аутентификация:** Требуется.
- **Параметры URL:**
  - `clientId` (string, обязательный): ID клиента.
- **Ответ (200 OK):** Тело ответа содержит изображение в формате SVG.

### 4.2. Скачать файл конфигурации клиента
- **Эндпоинт:** `GET /api/wireguard/client/{clientId}/configuration`
- **Описание:** Возвращает конфигурацию клиента WireGuard в виде файла `.conf`.
- **Аутентификация:** Требуется.
- **Параметры URL:**
  - `clientId` (string, обязательный): ID клиента.
- **Ответ (200 OK):** Тело ответа содержит текстовое содержимое файла конфигурации. Заголовок `Content-Disposition` настроен для инициации скачивания файла.

### 4.3. Сгенерировать одноразовую ссылку для конфигурации
- **Эндпоинт:** `POST /api/wireguard/client/{clientId}/generateOneTimeLink`
- **Описание:** Генерирует уникальный, одноразовый URL для скачивания файла конфигурации клиента. Эта функция должна быть включена на сервере.
- **Аутентификация:** Требуется.
- **Параметры URL:**
  - `clientId` (string, обязательный): ID клиента.
- **Ответ (200 OK):**
  ```json
  {
    "success": true
  }
  ```
  *(Примечание: Сама ссылка хранится в объекте клиента, который можно получить через `GET /api/wireguard/client`)*

### 4.4. Публичный URL для одноразового скачивания
- **Эндпоинт:** `GET /cnf/{clientOneTimeLink}`
- **Описание:** Публичный URL для скачивания файла конфигурации. Эту ссылку можно использовать только один раз, после чего она становится недействительной.
- **Аутентификация:** Не требуется.
- **Параметры URL:**
  - `clientOneTimeLink` (string, обязательный): Уникальный токен для одноразовой ссылки.
- **Ответ (200 OK):** Тело ответа содержит текстовое содержимое файла конфигурации.

---

## 5. Резервное копирование и восстановление

### 5.1. Резервное копирование конфигурации
- **Эндпоинт:** `GET /api/wireguard/backup`
- **Описание:** Создает резервную копию конфигурации сервера (включая всех клиентов) и возвращает ее в виде JSON-файла.
- **Аутентификация:** Требуется.
- **Ответ (200 OK):** Тело ответа содержит JSON-файл.

### 5.2. Восстановление конфигурации
- **Эндпоинт:** `PUT /api/wireguard/restore`
- **Описание:** Восстанавливает конфигурацию сервера из файла резервной копии.
- **Аутентификация:** Требуется.
- **Тело запроса:**
  ```json
  {
    "file": "..."
  }
  ```
  - `file` (string, обязательный): Содержимое JSON-файла резервной копии в виде строки.
- **Ответ (200 OK):**
  ```json
  {
    "success": true
  }
  ```

---

## 6. Метрики Prometheus

Если на сервере включен сбор метрик, их можно получить с помощью следующих эндпоинтов.

### 6.1. Получить метрики (текстовый формат)
- **Эндпоинт:** `GET /metrics`
- **Описание:** Возвращает метрики WireGuard в текстовом формате Prometheus.
- **Аутентификация:** Требуется отдельный пароль, если установлена переменная `PROMETHEUS_METRICS_PASSWORD`.

### 6.2. Получить метрики (формат JSON)
- **Эндпоинт:** `GET /metrics/json`
- **Описание:** Возвращает метрики WireGuard в формате JSON.
- **Аутентификация:** Требуется отдельный пароль, если установлена переменная `PROMETHEUS_METRICS_PASSWORD`.